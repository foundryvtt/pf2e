<div class="tab spells" data-group="primary" data-tab="spells">

    <div id="npc__spells">

        <ol>
            {{#each spellcastingEntries as |entry eid|}}

                <li class="spell item spellcasting-entry" data-container-type="spellcastingEntry" data-item-id="{{entry._id}}" data-container-id="{{entry._id}}">
                    <div class="spell__header" data-item-panel="toggle">
                        {{#if entry.data.prepared}}
                            <a class="prepared-toggle" title="{{localize 'PF2E.ToggleSpellVisibilityTitle' }}"><i class="fas {{#if entry.data.showUnpreparedSpells.value}}fa-book-open{{else}}fa-book{{/if}}"></i></a>
                        {{/if}}

                        <h4 class="spell__title">{{entry.name}}</h4>

                        <div class="input-container spell__values">
                            <div class="input-group spell__dc">
                                <label title="{{entry.data.dc.breakdown}}">{{ localize 'PF2E.NPC.Spells.DCLabel' }}</label>
                                <input type="number" class="modifier" data-spellcasting-input="dc" data-display-value="{{entry.data.dc.value}}" data-base-property="data.items.{{eid}}.data.spelldc.dc" value="{{entry.data.dc.value}}" data-dtype="Number" placeholder="0"/>
                            </div>
                            <div class="input-group spell__attack">
                                <label title="{{entry.data.attack.breakdown}}">{{ localize 'PF2E.NPC.Spells.AttackLabel' }}</label>
                                <input type="number" class="modifier" data-spellcasting-input="attack" data-display-value="{{entry.data.attack.value}}" data-base-property="data.items.{{eid}}.data.spelldc.value" value="{{ numberFormat entry.data.attack.value decimals=0 }}" data-dtype="Number" placeholder="0"/>
                            </div>
                            <div class="input-group spell__ability">
                                <!-- <label title="{{entry.data.ability.label}}">{{localize "PF2E.AbilityTitle"}}</label> -->
                                <select data-spellcasting-input="ability-scores" data-base-property="data.items.{{eid}}.data.ability.value" data-dtype="String">
                                    {{#select entry.data.ability.value}}
                                        <option value="str">{{localize "PF2E.AbilityId.str"}}</option>
                                        <option value="dex">{{localize "PF2E.AbilityId.dex"}}</option>
                                        <option value="con">{{localize "PF2E.AbilityId.con"}}</option>
                                        <option value="int">{{localize "PF2E.AbilityId.int"}}</option>
                                        <option value="wis">{{localize "PF2E.AbilityId.wis"}}</option>
                                        <option value="cha">{{localize "PF2E.AbilityId.cha"}}</option>
                                    {{/select}}
                                </select>
                            </div>
                        </div>
                        {{#if ../options.editable}}
                            <div class="item-controls controls">
                                {{#if ../options.editable }}
                                <a class="item-add add spell-create" title="{{ localize 'PF2E.NPC.Add' }}" data-type="spell" data-level="{{eid}}" data-location="{{entry._id}}"><i class="fas fa-plus"></i></a>
                                <a class="item-control spell-browse" title="{{localize 'PF2E.OpenSpellBrowserTitle'}}" data-type="spell" data-level="{{eid}}" data-location="{{entry._id}}"><i class="fas fa-search"></i></a>
                                {{/if}}
                                <a class="item-control spellcasting-remove" title="{{localize 'PF2E.RemoveSpellcastingEntryTitle' }}" data-type="{{eid}}"><i class="fas fa-trash"></i></a>
                            </div>
                        {{/if}}
                    </div>

                    <div class="spell__body" data-item-panel="content" data-visibility="visible">

                        {{#unless entry.data.prepared}}
                        <!-- Everything except prepared spells -->
                            <!-- Add section for each spell level -->
                            {{#each entry.spellbook as |section lvl|}}
                                <section class="spell__book" data-item-id="{{entry._id}}" data-item-type="spellLevel" data-level="{{lvl}}">
                                    {{#if section.spells.length}}
                                    <div class="spell__subheader">

                                        <div class="info-container info-header">
                                            <h4 class="spell__title">{{localize section.label}}</h4>
                                            {{#if section.isCantrip}}
                                                <div class="input-group">
                                                    <span>&infin;</span>
                                                    <span>/</span>
                                                    <span>&infin;</span>
                                                </div>
                                            {{else}}
                                                {{#unless entry.data.tradition.focus}}
                                                    {{#unless entry.data.tradition.ritual}}
                                                        <div class="input-group">
                                                            <input type="number" class="spell-slots-input" name="data.items.{{eid}}.data.slots.slot{{lvl}}.value" value="{{section.uses}}" placeholder="0" data-dtype="Number"/>
                                                            <span class="flex0"> / </span>
                                                            <input class="spell-max-input" type="number" name="data.items.{{entry._id}}.data.slots.slot{{lvl}}.max" value="{{section.slots}}" placeholder="0" data-dtype="Number"/>

                                                            <a class="spell-slots-increment-reset" data-item-id="{{entry._id}}"  data-level="{{lvl}}"><i class="fas fa-redo"></i></a>
                                                        </div>
                                                    {{/unless}}
                                                {{/unless}}
                                            {{/if}}

                                            {{#if entry.data.tradition.focus}}
                                                <div class="spell__focus input-group">
                                                    <label class="label">{{ localize 'PF2E.Focus.label' }}</label>
                                                    <input type="number" data-spellcasting-input="focus-points" data-base-property="data.items.{{eid}}.data.focus.points" name="data.items.{{entry._id}}.data.focus.points" value="{{numberFormat entry.data.focus.points decimals=0}}" data-dtype="Number" placeholder="0"/>
                                                    <span>/</span>
                                                    <input type="number" class="focus__pool" data-spellcasting-input="focsu-pool" data-base-property="data.items.{{eid}}.data.focus.pool" name="data.items.{{entry._id}}.data.focus.pool" value="{{numberFormat entry.data.focus.pool decimals=0}}" data-dtype="Number" placeholder="0"/>
                                                </div>
                                            {{/if}}
                                        </div>

                                        <div class="info-container">
                                            <div class="spell__range label">{{ localize 'PF2E.SpellRangeLabel' }}</div>
                                            <div class="spell__components label">{{ localize 'PF2E.NPC.Spells.SpellComponentsShortLabel' }}</div>
                                        </div>
                                    </div>
                                    {{/if}}
                                    <ul class="spell__list item-list">
                                        {{#each section.spells as |spell i|}}
                                            <li class="item" data-item-id="{{spell._id}}" data-spell="{{spell._id}}" data-slot-id="{{i}}" data-spell-lvl="{{lvl}}" data-entry-id="{{entry._id}}" data-expended-state="{{spell.expended}}" data-item-controls="toggle">
                                                <div class="item__header spell__subheader">

                                                    <div class="item__name">
                                                        <img class="item__icon spell-icon rollable" data-spell="rollable" src="{{spell.img}}" />
                                                        <a data-item-panel="toggle">{{ spell.name }} <span class="activity-icon">{{spell.glyph}}</span></a>
                                                    </div>

                                                    <div class="info-container">
                                                        <div class="spell__range">{{spell.data.range.value}}</div>
                                                        <div class="spell__components">
                                                            {{#if spell.data.components.somatic }}<div class="tag">{{ localize 'PF2E.SpellComponentShortS' }}</div>{{/if}}
                                                            {{#if spell.data.components.verbal }}<div class="tag">{{ localize 'PF2E.SpellComponentShortV' }}</div>{{/if}}
                                                            {{#if spell.data.components.material }}<div class="tag">{{ localize 'PF2E.SpellComponentShortM' }}</div>{{/if}}
                                                        </div>
                                                    </div>
                                                    <div class="controls" data-item-controls="content" data-visibility="hidden">
                                                        <a class="item-chat chat" title="{{ localize 'PF2E.NPC.SendToChat'}}"><i class="fas fa-comment-alt"></i></a>
                                                        {{#if  @root/options.editable}}
                                                        <a class="item-edit edit" title="{{ localize 'PF2E.NPC.Edit'}}"><i class="fas fa-edit"></i></a>
                                                        <a class="item-delete delete" title="{{ localize 'PF2E.NPC.Remove' }}"><i class="fas fa-trash"></i></a>
                                                        {{/if}}
                                                    </div>
                                                </div>
                                                {{> "systems/pf2e/templates/actors/npc/partials/npc-spell-body.html" spell=spell}}
                                            </li>
                                        {{/each}}
                                    </ul>
                                </section>
                            {{/each}}
                        {{else}}
                        <!-- Prepared Spells -->
                            <!-- Add section for each level -->
                            {{#each entry.spellbook as |section lvl|}}
                                <div class="section spellbook-header" data-item-id="{{entry._id}}" data-item-type="spellLevel" data-level="{{lvl}}">
                                    <div class="section-header">
                                        {{#if entry.data.showUnpreparedSpells.value}}
                                            <a class="level-prepared-toggle" title="{{localize "PF2E.ToggleSpellVisibilityLevelTitle"}}">
                                                <i class="fas {{#if section.displayPrepared}}fa-book-open{{else}}fa-book{{/if}}"></i>
                                            </a>
                                        {{/if}}
                                        <h4>{{localize section.label}}</h4>
                                        <input class="spell-max-input" type="number" name="data.items.{{entry._id}}.data.slots.slot{{lvl}}.max" value="{{section.slots}}" placeholder="0" data-dtype="Number"/>
                                    </div>
                                    <ul class="spells-list">

                                    {{#unless entry.data.tradition.focus}}
                                        {{#each section.prepared as |spell i|}}
                                            {{#if spell.prepared}}
                                                <li class="item spell" data-item-id="{{spell._id}}" data-spell="{{spell._id}}" data-slot-id="{{i}}" data-spell-lvl="{{lvl}}" data-entry-id="{{entry._id}}" data-expended-state="{{spell.expended}}">
                                                    <div class="spell-header">
                                                        <div class="spell-icon rollable"><img src="{{spell.img}}" /></div>
                                                        <div class="spell-name rollable">
                                                            <a class="{{#if spell.expended}}expended{{/if}}">{{ spell.name }} <span class="activity-icon">{{spell.glyph}}</span></a></h4>
                                                        </div>
                                                        <div class="spell-range">
                                                            {{ spell.data.range.value }}
                                                        </div>
                                                        <div class="spell-components">
                                                            {{#if spell.data.components.somatic }}<div class="tag">{{ localize 'PF2E.SpellComponentShortS' }}</div>{{/if}}
                                                            {{#if spell.data.components.verbal }}<div class="tag">{{ localize 'PF2E.SpellComponentShortV' }}</div>{{/if}}
                                                            {{#if spell.data.components.material }}<div class="tag">{{ localize 'PF2E.SpellComponentShortM' }}</div>{{/if}}
                                                        </div>
                                                        <div class="item-controls spell-controls controls expandable">
                                                            <a class="item-chat chat" title="{{ localize 'PF2E.NPC.SendToChat'}}"><i class="fas fa-comment-alt"></i></a>
                                                            {{#if @root/options.editable }}
                                                            {{#unless ../section.isCantrip}}
                                                                <a class="item-control item-toggle-prepare" title="{{localize "PF2E.ExpendSpellTitle"}}"><i class="fas fa-minus-square"></i></a>
                                                            {{/unless}}
                                                            <a class="item-control item-unprepare" title="{{localize "PF2E.UnprepareItemTitle"}}"><i class="fas fa-trash"></i></a>
                                                            {{/if}}
                                                        </div>
                                                    </div>
                                                    {{> "systems/pf2e/templates/actors/npc/partials/npc-spell-body.html" spell=spell}}
                                                </li>
                                            {{else}}
                                                <li class="item spell" data-item-id="{{i}}" data-spell-lvl="{{lvl}}" data-item-type="spellSlot" data-entry-id="{{entry._id}}">
                                                    <div class="spell-header">
                                                        <div class="spell-name empty">
                                                            <h4>{{spell.name}}</h4>
                                                        </div>
                                                    </div>
                                                </li>
                                            {{/if}}

                                        {{/each}}
                                    </ul>
                                </div>
                                    {{#if entry.data.showUnpreparedSpells.value}}
                                        {{#if section.displayPrepared}}
                                            <div class="section spellbook-header" data-item-id="{{entry._id}}" data-item-type="spellLevel" data-level="{{lvl}}">
                                                <div class="section-header">
                                                    <h4>{{unpreparedSpellsLabel}}</h4>
                                                </div>
                                                <ul class="spells-list">

                                                    <!-- Unprepared Spells -->
                                                    {{#each section.spells as |spell i|}}
                                                    <li class="item spell unprepared" data-item-id="{{spell._id}}" data-spell="{{spell._id}}" data-slot-id="{{i}}" data-spell-lvl="{{lvl}}" data-entry-id="{{entry._id}}">
                                                        <div class="spell-header">
                                                            <div class="spell-name rollable">
                                                                <a>{{spell.name}} <span class="activity-icon">{{spell.glyph}}</span></a></h4>
                                                            </div>
                                                            <div class="spell-range">{{ spell.data.range.value }}</div>
                                                            <div class="spell-components">
                                                                {{#if spell.data.components.somatic }}<div class="tag">{{ localize 'PF2E.SpellComponentShortS' }}</div>{{/if}}
                                                                {{#if spell.data.components.verbal }}<div class="tag">{{ localize 'PF2E.SpellComponentShortV' }}</div>{{/if}}
                                                                {{#if spell.data.components.material }}<div class="tag">{{ localize 'PF2E.SpellComponentShortM' }}</div>{{/if}}
                                                            </div>
                                                            <div class="item-controls spell-controls controls expandable">
                                                                {{#if @root/options.editable }}
                                                                <a class="item-control item-edit" title="{{localize "PF2E.EditItemTitle"}}"><i class="fas fa-edit"></i></a>
                                                                <a class="item-control item-delete" title="{{localize "PF2E.DeleteItemTitle"}}"><i class="fas fa-trash"></i></a>
                                                                {{/if}}
                                                            </div>
                                                        </div>
                                                        {{> "systems/pf2e/templates/actors/npc/partials/npc-spell-body.html" spell=spell}}
                                                    </li>
                                                    {{/each}}
                                                </ul>
                                            </div>
                                        {{/if}}
                                    {{/if}}
                                {{else}}
                                    <!-- Add spell items for each level -->
                                    {{#each section.spells as |item i|}}
                                        <li class="item" data-spell-lvl="1" data-item-id="{{item._id}}">
                                            <div class="item-name rollable">
                                                <div class="item-image">
                                                    <img class="item-icon" src="{{item.img}}" alt="{{item.name}}">
                                                </div>
                                                <h4>{{item.name}}</h4>
                                            </div>

                                            <div class="spell-school">{{item.data.school.str}}</div>
                                            <div class="spell-action">{{item.data.time.value}}</div>

                                            {{#if @root.owner}}
                                                <div class="item-controls">
                                                    <a class="item-control item-edit" title="{{localize "PF2E.EditItemTitle"}}"><i class="fas fa-edit"></i></a>
                                                    <a class="item-control item-delete" title="{{localize "PF2E.DeleteItemTitle"}}"><i class="fas fa-trash"></i></a>
                                                </div>
                                            {{/if}}
                                        </li>
                                    {{/each}}
                                {{/unless}}
                            {{/each}}
                    {{/unless}}
                    </div>
                </li>

            {{/each}}
        </ol>
        {{#if options.editable}}
        <div class="footer">
            <button type="button" class="btn spellcasting-create"><span>{{ localize 'PF2E.NPC.Spells.AddSpellCastingType' }}</span></button>
        </div>
        {{/if}}
    </div>
</div>
